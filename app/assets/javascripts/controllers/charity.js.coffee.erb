<% environment.context_class.instance_eval { include ActionView::Helpers } %>
<% environment.context_class.instance_eval { include HostHelper } %>
<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>

App.controller 'CharityCtrl', ['$scope', '$location', '$timeout', '$http', '$routeParams', '$rootScope', \
                            ($scope, $location, $timeout, $http, $routeParams, $rootScope) ->
  $scope.bn = $routeParams.bn

  $scope.setCharityData = ->
    # Ensure rootScope contains a charities object.
    $rootScope.charities = {} if 'charities' not of $rootScope

    if $routeParams.bn not of $rootScope.charities
      # Load the charity if we haven't yet.
      url = "<%= site_host() %>/api/charity/#{$scope.bn}"

      $http.get(url)
        .success((data, status, headers, config) ->
          $scope.charityData = data
          $rootScope.charities[$scope.bn] = data.results
        )
    else
      # Otherwise get the cached data from rootScope.
      $scope.charityData = $rootScope.charities[$scope.bn]

  $scope.setCharityData()
]
